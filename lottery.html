<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="no"/>
    <meta name="wap-font-scale" content="no">
    <meta content="telephone=no" name="format-detection">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>滚滚筹-抽奖</title>
    <link rel="stylesheet" href="css/swiper.min.css">
    <link rel="stylesheet" href="css/common.min.css">
    <link rel="stylesheet" href="css/base.min.css">
    <link rel="stylesheet" href="css/user.min.css">
</head>
<body class="isHide">
<div class="wrap height top">
    <div class="header">
        <div class="left">
            <a href="javascript:;">
                <i class="sprite icon-back"></i>
            </a>
        </div>
        <div class="mid">
            <label class="text"><span>幸运大转盘</span></label>
        </div>
    </div>
    <div class="wrap height overflow">
        <div class="lottery-box">
            <label class="integral">可用积分：<em>5000</em></label>
            <div class="container">
                <div class="p-rel">
                    <div class="lottery">
                        <div class="bg">
                            <div class="fb-box-list" id="lottery">
                                <ul class="row-3">
                                    <li>
                                        <div class="award-box award-box-0">
                                            <label><img src="img/lottery/award1.png"></label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="award-box award-box-1">
                                            <label><img src="img/lottery/award4.png"></label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="award-box award-box-2">
                                            <label><img src="img/lottery/award3.png"></label>
                                        </div>
                                    </li>
                                </ul>
                                <ul class="row-3">
                                    <li>
                                        <div class="award-box award-box-7">
                                            <label><img src="img/lottery/award3.png"></label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="award-box background">
                                            <a id="lotteryBtn" href="javascript:;"><img
                                                    src="img/lottery/lottery-btn.png"></a>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="award-box award-box-3">
                                            <label><img src="img/lottery/award1.png"></label>
                                        </div>
                                    </li>
                                </ul>
                                <ul class="row-3">
                                    <li>
                                        <div class="award-box award-box-6">
                                            <label><img src="img/lottery/award2.png"></label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="award-box award-box-5">
                                            <label><img src="img/lottery/award5.png"></label>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="award-box award-box-4">
                                            <label><img src="img/lottery/award6.png"></label>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="shadow">
                        <label><img src="img/lottery/lottery-shadow.png"></label>
                    </div>
                    <div class="gold">
                        <label class="left"><img src="img/lottery/lottery-matter2.png"></label>
                        <label class="right"><img src="img/lottery/lottery-matter3.png"></label>
                    </div>
                </div>
                <div class="intro">
                    <p>抽奖说明：</p>
                    <label>
                        <span>1、每10积分可以进行一次抽奖；</span>
                        <span>2、最终解释权归本公司所有；</span>
                    </label>
                </div>
                <div class="list">
                    <label class="title"><img src="img/lottery/lottery-list-line.png"></label>
                    <div class="cont">
                        <label><span>中奖名单</span></label>
                        <div class="cont-height">
                            <ul id="winListContainer">
                                <li class="background">
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                                <li>
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                                <li class="background">
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                                <li>
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                                <li class="background">
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                                <li>
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                                <li class="background">
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                                <li>
                                    <span class="user">135****5548</span>
                                    <span>获得</span>
                                    <span class="ticket">1.5%增益券</span>
                                    <span class="time">2017/11/12</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="bg"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery-1.11.1.min.js"></script>
<script src="js/box.js"></script>
<script src="js/common.js"></script>
<script src="js/base.js"></script>
<script>
    $(function () {
        //滚动
        var _clearTimer_ = 0;
        var marqueeText = function (tag, slideDir, time) {
            clearInterval(_clearTimer_);
            _clearTimer_ = setInterval(function () {
                var _top = parseInt($(tag).css("marginTop"));
                var _moveHeight = $(tag).find("li:eq(0)").height();
                switch (slideDir) {
                    case "top":
                        $(tag).animate({
                            "marginTop": _top - _moveHeight + "px"
                        }, 300, function () {
                            $(tag).css({"marginTop": 0}).children("li").last().after($(tag).children("li").first());
                        });
                        break;
                }
            }, time);
        };

        //中奖信息滚动
        marqueeText("#winListContainer", "top", 2000);

        //奖品信息
        var award = [
            {text: "10积分", num: 10, index: 1},
            {text: "1.25%增益券", num: 125 / 100, index: 2},
            {text: "100积分", num: 100, index: 3},
            {text: "10积分", num: 10, index: 4},
            {text: "再接再厉", num: 0, index: 5},
            {text: "2.25%增益券", num: 225 / 100, index: 6},
            {text: "88积分", num: 88, index: 7},
            {text: "100积分", num: 100, index: 8}
        ];

        //抽奖代码
        var lottery = {
            index: -1,    //当前转动到哪个位置，起点位置
            count: 0,     //总共有多少个位置
            timer: 0,     //setTimeout的ID，用clearTimeout清除
            speed: 20,    //初始转动速度
            times: 0,     //转动次数
            cycle: 50,    //转动基本次数：即至少需要转动多少次再进入抽奖环节
            prize: -1,    //中奖位置
            init: function (id) {
                if ($(id).find('.award-box').length > 0) {
                    var $lottery = $(id);
                    var $units = $lottery.find('.award-box').not(".background");
                    this.obj = $lottery;
                    this.count = $units.length;
                    $lottery.find('.award-box.award-box-' + this.index).addClass('active');
                }
            },
            roll: function () {
                var index = this.index;
                var count = this.count;
                var lottery = this.obj;
                $(lottery).find('.award-box.award-box-' + index).removeClass('active');
                index += 1;
                if (index > count - 1) {
                    index = 0;
                }
                $(lottery).find('.award-box.award-box-' + index).addClass('active');
                this.index = index;
                return false;
            },
            stop: function (index) {
                this.prize = index;
                return false;
            }
        };

        function roll() {
            lottery.times += 1;
            lottery.roll(); //转动过程调用的是lottery的roll方法，这里是第一次调用初始化

            if (lottery.times > lottery.cycle + 10 && lottery.prize == lottery.index) {
                clearTimeout(lottery.timer);
                var lottery_num = lottery.prize;
                var lottery_text = award[lottery.prize].text;
                var html = "";
                if (lottery_num == 4) {
                    html = lotteryHtml(false, null);
                } else {
                    html = lotteryHtml(true, lottery_text);
                }
                setTimeout(function () {
                    $(document.body).append(html);

                    $("#lotteryClose").click(function () {
                        $(".disk-lottery").fadeOut(300, function () {
                            $(this).remove();
                        });
                    });
                }, 1000);
                lottery.prize = -1;
                lottery.times = 0;
                click = false;
            } else {
                if (lottery.times < lottery.cycle) {
                    lottery.speed -= 10;
                } else if (lottery.times == lottery.cycle) {
                    lottery.prize = Math.random() * (lottery.count) | 0; //静态演示，随机产生一个奖品序号，实际需请求接口产生
                } else {
                    if (lottery.times > lottery.cycle + 10 && ((lottery.prize == 0 && lottery.index == 7) || lottery.prize == lottery.index + 1)) {
                        lottery.speed += 110;
                    } else {
                        lottery.speed += 20;
                    }
                }
                if (lottery.speed < 40) {
                    lottery.speed = 40;
                }
                lottery.timer = setTimeout(roll, lottery.speed); //循环调用
            }
            return false;
        }


        function lotteryHtml(type, lotteryText) {
            var img = type ? "img/lottery/pop-lottery-s.png" : "img/lottery/pop-lottery-e.png";
            var text = type ? "恭喜你！" : "很遗憾";
            var lottery_text = type ? "获得<em>" + lotteryText + "</em>,奖励已放入<br>您的账户中。" : "你没有获得任何奖励！";
            var btnText = type ? "立即领取" : "继续抽奖";
            var btnID = type ? "successBtn" : "errorBtn";
            return '\
                <div class="disk-lottery">\
                    <div class="pop-lottery">\
                        <div class="cont">\
                            <div class="close"><a id="lotteryClose" href="javascript:;">&times;</a></div>\
                            <div class="title"><label><img src=' + img + '></label></div>\
                            <div class="text">\
                                <label>' + text + '</label>\
                                <span>' + lottery_text + '</span>\
                            </div>\
                            <a class="btn" href="javascript:;" id=' + btnID + '>' + btnText + '</a>\
                        </div>\
                    </div>\
                </div>\
            ';
        }

        lottery.init('#lottery');
        var click = false;

        $("#lotteryBtn").click(function () {
            if (click) { //click控制一次抽奖过程中不能重复点击抽奖按钮，后面的点击不响应
                return false;
            } else {
                lottery.speed = 100;
                roll(); //转圈过程不响应click事件，会将click置为false
                click = true; //一次抽奖完成后，设置click为true，可继续抽奖
                return false;
            }
        });
    })
</script>
</body>
</html>